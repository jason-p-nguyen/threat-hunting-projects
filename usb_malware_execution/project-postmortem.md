# üß† Threat Hunting Postmortem ‚Äì USB Malware Execution via PowerShell

## 1. üóÇ Project Overview

**Project Title:**  
USB Malware Execution via PowerShell

**Threat Scenario:**  
A malicious payload is executed through PowerShell, triggered by USB insertion on a Windows system. This simulates a physical attack vector used to compromise an endpoint.

**Goal of the Hunt:**  
To simulate a USB drop attack in a cloud VM environment. This included:
- Creating a simulated USB device
- Developing a PowerShell-based malware with C2 beaconing
- Executing the malware
- Detecting and investigating the behavior using logs and KQL queries

---

## 2. ‚úÖ What Went Well

- The threat hunting process flowed smoothly due to a **step-by-step guide** I wrote beforehand.
- **Preset KQL queries** helped speed up log investigation, allowing me to adapt inputs quickly.
- Used a **pipeline** from threat simulation to report writing, integrating ChatGPT for speed and clarity.

**Effective Tools & Techniques:**
- **KQL** was highly effective for querying the right logs across MDE and Sentinel.
- Having a **structured guide** made the hunt feel streamlined and repeatable.
- **ChatGPT** was invaluable in debugging the malware and helping write the report.

**Skills Demonstrated:**
- Threat hunting and **log investigation with KQL**
- Use of **hunting and reporting templates**
- Filtering out noise to detect abnormal behavior
- Aligning findings to **MITRE ATT&CK** and the **Cyber Kill Chain**
- Building a **threat-to-report pipeline** that can scale across future projects

---

## 3. ‚ö†Ô∏è What Could Be Improved

- **Malware did not execute properly** on the first attempt ‚Äî several debugging cycles created excess noise in the logs.
- The VM's **admin account couldn‚Äôt create user accounts**, so the exploit had to run under admin‚Äîless realistic for this scenario.

**Mistakes & Oversights:**
- I only used logs from the final (successful) malware run, skipping earlier attempts. These earlier logs could have added realism by showing the "noise" or failed execution stages of a threat actor.
- Lack of a non-admin user schema reduced realism in the simulation.

---

## 4. üìò Lessons Learned

- Next time, I may use **pre-built malware** or tools like **Metasploit** to focus more on detection and forensics, rather than debugging malware.
- Set up a VM with a **realistic user environment** (non-admin) to reflect typical enterprise systems.
- Keep refining the **step-by-step template**, and possibly **integrate the Kill Chain into threat scenario design**.
- Separate the project into **distinct phases**: threat creation, threat hunt, incident response, reporting.
- Explore **forensics and malware reverse engineering** (e.g., decoding payloads, analyzing C2 behavior).
- In future versions, I‚Äôd like to make the **malware more stealthy**, to better mimic real-world threats and make it more difficult to detect or decipher in log data.

**Insights Gained:**
- A structured threat hunting process can be **systematized** and repeated.
- Given my current coding limits, it‚Äôs better to work with known samples and shift toward malware creation later.
- There‚Äôs value in switching tools (e.g., MDE ‚Üí Sentinel) to learn different detection mechanisms.

**Shift in Approach:**
- The **step-by-step approach** kept me focused, and served as a fallback whenever I got lost. I‚Äôve found that maintaining this structure is essential.

---

## 5. üîÆ Next Steps & Future Ideas

**Expansion Ideas:**
- Use **Metasploit** or known malware samples to enhance realism
- Build **custom malware** with better functionality
- Simulate attacks on a **larger network**
- Add a full **incident response section** to complement the hunt

**Future Focus:**
- Might pivot to **CVE remediation** or **Linux hardening/remediation** for future portfolio pieces

**Real-World Relevance:**
- Yes ‚Äî this project models a plausible USB-based attack and shows how an analyst could detect and investigate it.
- Also highlights how attackers might leverage **LLMs like ChatGPT** to generate or debug malware, a relevant emerging concern.

---

## 6. üõ† Tools & References

**Tools Used:**
- PowerShell
- KQL (Kusto Query Language)
- Microsoft Defender for Endpoint (MDE)
- Microsoft Azure
- ChatGPT

**GitHub Repository:**  
üîó [USB Malware Execution ‚Äì Threat Hunting Project](https://github.com/jason-p-nguyen/threat-hunting-projects/tree/main/usb_malware_execution)

---

